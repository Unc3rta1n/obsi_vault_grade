## Продвинуто Docker и Docker Compose

Docker — это платформа для разработки, отправки и выполнения приложений в контейнерах, что позволяет создавать, развертывать и запускать приложения в изолированном и переносимом окружении. Docker Compose — это инструмент для определения и запуска многоконтейнерных Docker приложений. В этом разделе рассматриваются более сложные аспекты работы с Docker и Docker Compose.

### 1. Docker: Продвинутое использование

#### 1.1. Dockerfile: Оптимизация

`Dockerfile` — это текстовый файл с набором инструкций для сборки Docker-образа. Для создания оптимизированных образов важно использовать лучшие практики.

- **Меньше слоёв в образе**: Каждый шаг в `Dockerfile` создает новый слой в образе. Чтобы уменьшить размер, объединяйте команды в один слой.

  Пример:
  ```dockerfile
  RUN apt-get update && apt-get install -y python3 python3-pip
  ```

- **Кэширование слоёв**: Docker использует кэш для слоёв, чтобы не повторять действия при следующей сборке. Это помогает ускорить сборку, но может быть проблемой, если вы хотите, чтобы шаг был выполнен снова. Для этого используйте инструкции, которые изменяются, например:

  ```dockerfile
  RUN echo $RANDOM > /tmp/random.txt
  ```

- **Использование многократных стадий сборки (multi-stage builds)**: Это позволяет использовать несколько `FROM` инструкций в одном `Dockerfile`, что помогает создавать более компактные и эффективные образы.

  Пример:
  ```dockerfile
  # Стадия сборки
  FROM node:14 AS build
  WORKDIR /app
  COPY . .
  RUN npm install && npm run build

  # Финальная стадия
  FROM nginx:alpine
  COPY --from=build /app/dist /usr/share/nginx/html
  ```

#### 1.2. Docker Networking

Docker поддерживает несколько типов сетевых драйверов, которые помогают организовать взаимодействие контейнеров.

- **Bridge** — используется по умолчанию, если не указать другой тип сети. Контейнеры могут взаимодействовать между собой по имени хоста.

  Пример:
  ```bash
  docker network create --driver bridge my_bridge_network
  ```

- **Host** — контейнеры используют сетевое пространство хоста, что может быть полезно для приложений, которым нужно работать с низким уровнем сети.

  Пример:
  ```bash
  docker run --network host my_container
  ```

- **Overlay** — используется для связи контейнеров, которые могут находиться на разных хостах, и является основной сетью для Docker Swarm и Kubernetes.

  Пример:
  ```bash
  docker network create --driver overlay my_overlay_network
  ```

#### 1.3. Docker Volumes

**Docker Volumes** позволяют контейнерам сохранять и обмениваться данными. Это особенно важно для приложений, которые сохраняют состояние (например, базы данных).

- **Создание тома**:
  ```bash
  docker volume create my_volume
  ```

- **Использование тома в контейнере**:
  ```bash
  docker run -v my_volume:/data my_image
  ```

- **Перенос данных между контейнерами**:
  Для обмена данными между контейнерами можно использовать тома. Это позволяет контейнерам читать и записывать данные в одном и том же месте.

#### 1.4. Docker Swarm

**Docker Swarm** — это нативное решение Docker для оркестрации, которое позволяет запускать кластер контейнеров на нескольких хостах.

- **Инициализация Swarm**:
  ```bash
  docker swarm init
  ```

- **Добавление рабочих узлов**:
  Для добавления узлов в кластер используйте команду с токеном, который выдаёт Docker.

- **Создание и развертывание сервисов в Swarm**:
  ```bash
  docker service create --name my_service --replicas 3 my_image
  ```

#### 1.5. Контейнеры и безопасность

- **Запуск контейнера с ограничениями**:
  Docker позволяет ограничивать использование ресурсов контейнерами, таких как память и CPU, что важно для обеспечения безопасности и производительности.

  Пример:
  ```bash
  docker run --memory 512m --cpus 1 my_image
  ```

- **Запуск контейнера с низкими привилегиями**:
  Чтобы снизить риски безопасности, контейнеры могут быть настроены на запуск от имени непривилегированного пользователя.

  Пример:
  ```bash
  docker run --user nobody my_image
  ```

---

### 2. Docker Compose: Продвинутое использование

**Docker Compose** позволяет определять и запускать многоконтейнерные Docker-приложения с помощью одного YAML файла. Каждый сервис в файле может быть настроен с собственными параметрами, такими как порты, тома, сети и переменные окружения.

#### 2.1. Основы файла `docker-compose.yml`

Пример файла `docker-compose.yml` для приложения с двумя сервисами:

```yaml
version: "3.9"

services:
  web:
    image: nginx
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
  app:
    build: ./app
    environment:
      - APP_ENV=production
```

В этом примере два сервиса: `web` и `app`. Сервис `web` использует образ Nginx, а сервис `app` строится из директории `./app`.

#### 2.2. Сетевые настройки

Docker Compose позволяет настраивать сети для контейнеров, чтобы они могли взаимодействовать между собой.

Пример настройки пользовательской сети:

```yaml
version: "3.9"

services:
  web:
    image: nginx
    networks:
      - my_network
  app:
    build: ./app
    networks:
      - my_network

networks:
  my_network:
    driver: bridge
```

#### 2.3. Многоконтейнерные приложения

Docker Compose упрощает запуск и настройку сложных многоконтейнерных приложений, таких как веб-приложения с базой данных.

Пример для веб-приложения с PostgreSQL:

```yaml
version: "3.9"

services:
  db:
    image: postgres
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    volumes:
      - db_data:/var/lib/postgresql/data

  web:
    image: my-web-app
    environment:
      DB_HOST: db
      DB_USER: user
      DB_PASSWORD: password
    depends_on:
      - db
    ports:
      - "8080:80"

volumes:
  db_data:
```

Здесь веб-сервис зависит от базы данных, и Compose управляет её настройкой и запуском в нужной последовательности.

#### 2.4. Развертывание и масштабирование сервисов

С Docker Compose можно легко масштабировать сервисы, чтобы увеличить их количество, например:

```bash
docker-compose up --scale web=3
```

Эта команда создаст три контейнера для сервиса `web`.

#### 2.5. Переменные окружения в Compose

В Docker Compose можно использовать переменные окружения для гибкой настройки контейнеров.

Пример использования переменных в `docker-compose.yml`:

```yaml
version: "3.9"

services:
  app:
    image: my-app
    environment:
      - DATABASE_URL=${DATABASE_URL}
```

Переменные окружения можно определить в `.env` файле:

```
DATABASE_URL=postgres://user:password@db:5432/mydb
```

#### 2.6. Docker Compose и Continuous Integration (CI)

Docker Compose также широко используется в процессах CI для тестирования и развертывания. В связке с CI/CD системами, такими как GitLab CI или Jenkins, Docker Compose позволяет изолировать тесты и запускать их в контейнерах.

Пример конфигурации CI для запуска тестов с использованием Docker Compose:

```yaml
stages:
  - test

test:
  stage: test
  services:
    - postgres:latest
  script:
    - docker-compose up -d
    - docker-compose run app npm test
    - docker-compose down
```

### Заключение

Docker и Docker Compose — это мощные инструменты для контейнеризации и управления многоконтейнерными приложениями. Знание продвинутых функций Docker, таких как многократные стадии сборки, управление сетями, безопасность и оркестрация с Docker Swarm, а также умение эффективно работать с Docker Compose позволяет ускорить разработку и повысить гибкость при работе с приложениями в контейнерах.
