# Миграции БД и Alembic

Миграции базы данных — это процесс изменения структуры базы данных в процессе разработки. В этом разделе рассмотрим основные аспекты миграций, а также инструменты, такие как **Alembic**, для работы с миграциями в SQLAlchemy.

## 1. Что такое миграции базы данных?

Миграции — это способ управления изменениями в структуре базы данных, который позволяет:
- Вносить изменения в схему базы данных (добавление, изменение и удаление таблиц или столбцов).
- Поддерживать совместимость между различными версиями базы данных в разных средах (например, разработка, тестирование, продакшн).
- Автоматизировать процессы обновлений базы данных при развертывании приложения.

## 2. Инструменты для миграций

### Alembic — инструмент для миграций в SQLAlchemy

**Alembic** — это инструмент миграций, который используется в проектах с SQLAlchemy для управления изменениями в базе данных. Он позволяет легко генерировать миграции, применить их и откатить.

### Основные команды Alembic:

1. **Инициализация Alembic**:
   Для начала работы с Alembic нужно инициализировать проект. Эта команда создаст директорию для миграций и конфигурационный файл `alembic.ini`:
   ```bash
   alembic init alembic
   ```

2. **Создание миграции**:
   После внесения изменений в модели базы данных, можно создать миграцию с помощью команды:
   ```bash
   alembic revision --autogenerate -m "Добавлена новая таблица"
   ```

   Опция `--autogenerate` позволяет Alembic автоматически сравнить текущую модель базы данных с состоянием базы данных и сгенерировать SQL-запросы для применения изменений.

3. **Применение миграций**:
   Чтобы применить миграции к базе данных, используем команду:
   ```bash
   alembic upgrade head
   ```
   Эта команда применяет все миграции до текущей версии базы данных.

4. **Откат миграций**:
   Для отката миграции можно использовать команду:
   ```bash
   alembic downgrade -1
   ```
   Эта команда откатывает последнюю миграцию. Для отката на конкретную версию можно использовать ID миграции, например:
   ```bash
   alembic downgrade <revision_id>
   ```

5. **Просмотр текущей версии базы данных**:
   Чтобы узнать, на какой версии находится база данных, используем:
   ```bash
   alembic current
   ```

## 3. Пример работы с Alembic

### Шаг 1: Создание модели

Предположим, у нас есть модель `User`:

```python
from sqlalchemy import Column, Integer, String
from sqlalchemy.ext.declarative import declarative_base

Base = declarative_base()

class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    name = Column(String, nullable=False)
    age = Column(Integer, nullable=False)
```

### Шаг 2: Создание миграции

После создания модели, запускаем команду для генерации миграции:

```bash
alembic revision --autogenerate -m "Создание таблицы users"
```

Alembic создаст файл миграции в каталоге `alembic/versions`.

### Шаг 3: Применение миграции

Применяем миграцию:

```bash
alembic upgrade head
```

Теперь база данных будет иметь таблицу `users` с колонками `id`, `name` и `age`.

### Шаг 4: Изменение модели

Если мы решим изменить модель, например, добавить новый столбец `email`, изменяем модель:

```python
class User(Base):
    __tablename__ = 'users'

    id = Column(Integer, primary_key=True)
    name = Column(String, nullable=False)
    age = Column(Integer, nullable=False)
    email = Column(String, nullable=True)
```

После изменения модели генерируем новую миграцию:

```bash
alembic revision --autogenerate -m "Добавлен столбец email"
```

И применяем миграцию:

```bash
alembic upgrade head
```

## 4. Преимущества использования миграций

6. **Автоматизация изменений**: Миграции автоматизируют процесс применения изменений в базе данных.
7. **Гибкость**: Можно легко добавлять, удалять или изменять таблицы и столбцы.
8. **Контроль версий**: Миграции позволяют контролировать изменения в базе данных и возвращаться к предыдущим состояниям.
9. **Совместимость с разными средами**: Миграции упрощают работу с базами данных в различных средах (разработка, тестирование, продакшн).

## 5. Заключение

Миграции являются неотъемлемой частью работы с базами данных в современных проектах, особенно при использовании таких инструментов, как Alembic. Они обеспечивают удобное управление изменениями базы данных и позволяют разработчикам работать с базой данных более эффективно.
